name: Firestore Catalogue Upload

on:
  workflow_dispatch:
  workflow_run:
    workflows:
      - Groq Firestore Payload Generator (2-Step Merge)
    types:
      - completed

jobs:
  upload:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    steps:
      # -----------------------------
      # STEP 0: DOWNLOAD ARTIFACT
      # -----------------------------
      - name: Download Firestore payload artifact
        uses: actions/download-artifact@v4
        with:
          name: firestore-payload
          path: payload

      - name: Verify payload
        run: |
          echo "===== PAYLOAD FILE ====="
          ls -l payload
          echo
          echo "===== mobileData.json ====="
          cat payload/mobileData.json
          jq empty payload/mobileData.json

      # -----------------------------
      # STEP 1: AUTHENTICATE GCP
      # -----------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          token_format: access_token

      # -----------------------------
      # STEP 2: CREATE FIRESTORE DOCUMENT
      # -----------------------------
      - name: Create Firestore document
        run: |
          curl -s -w "\nHTTP %{http_code}\n" -X POST \
            "https://firestore.googleapis.com/v1/projects/site-9686c/databases/(default)/documents/Catalogue?documentId=Moto422" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            --data-binary @payload/mobileData.json
