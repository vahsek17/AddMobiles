name: Fetch Groq & Upload to FireStore

on:
  workflow_dispatch:

jobs:
  groq-pipeline:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # STEP 1: BASE CATALOGUE CALL
      # -----------------------------
      - name: Groq Call 1 – Base catalogue
        run: |
          RESPONSE_1=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.GROQ_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "groq/compound-mini",
              "messages": [
                {
                  "role": "user",
                    "content": "STRICT_MODE=TRUE; generate Firestore REST JSON ONLY for Motorola Edge 50 Pro enrichment data, exactly ONE JSON object in ONE single paragraph with NO line breaks, with ROOT key `fields`; EVERY field MUST use google.firestore.v1.Value wrappers (stringValue); include ONLY the following keys in this EXACT ORDER(attributes are only in String fromat): model: `Model No. of the smartphone`,architecture: `bits, chipset, fabrication etc.`, aspectRatio: `Aspect Ratio`, audioFeatures: `Audio bit rate, sampling frequency, dolby atmos etc.`, audioJack: `Yes or None`, availableStorage: `All the storage variants 64GB,128GB etc. `, battery: `a realistic spec score of battery based on quality, run time, and mAh defined by - Spec Score: <percentage%>`, batteryCapacity: `Capacity followed by mAh`, batteryRemovable: `Yes or No`, batteryTalkTime: `talktime on single charge, for example - Up to x Hours (4G)`, batteryType: `eg lipo, li-ion etc.`, benchMarks: `All available benchmarks(antutu, geekbench etc..) scores mentioned along with the cores(if present), such as <value>(single-core), <value>(multi-core) `, bezelLessDisplay: `If bezzle-less or not/camera hole type, water drop/ punch hole design`, bluetooth: `version of bluetooth supported`, chipset: `exact name of the chipset used`, colours: `exact Color-shades of phone followed by hex codes`, comparePrices: `price in india followed by INR`, cpu: `number of cores, max frequency on cores (in user understandable format),and a realistic Spec Score in% of the cpu appended at the end. eg: Octa core (2.9 GHz, Single core, Cortex X1 + 2.8 GHz, Tri core, Cortex A78 + 2.2 GHz, Quad core, Cortex A55), Spec Score: x%`, customUi: `Custom UI of the company eg. miui, one Ui etc`, dimensions: `Dimensions in mm L x B x H mm`, displayType: `amoled, led, lcd etc., & Type of HDR eg. HDR+`, expandable: `Yes or No - if the storage is expandable`, fingerprintType: `N/A if not available, otherwise Either Ultrasonic or Optical`, fingerprintPosition: `On-screen, back, Side-mounted etc if fingerprint is available on device`, fingerprintSensor: `mention Yes if it is present else No`, fmRadio: `Mention Yes if it is present else No`, frontAutofocus: `Yes or no, type etc..`, frontCamera: `Overall Megapixels, OIS (if present on front), and realistic Spec Score based on quality, pixels, resolution`, frontCameraSetup: `Mention Single/Dual Camera - followed by Resolution in MP, Followed by a realistic specs score in format: Spec Score: x%`, frontFlash: `Mention Yes if present, else No`, frontResolution: `No of Megapixels, Focal length and other detials related to resolution ex: 40 MP f/2.2, Wide Angle, Primary Camera`, frontVideo: `Mention the resolution supported at different Frames per seconds`, gps: `positioning system with its type, for example: Yes with A-GPS, Glonass`, graphics: `For example: Mali-G78 MP14 etc.`, hdr: `version/type`, internalMemory: `Memory varients available - separated by `/`, for ex. 48GB/64GB etc`, launchDate: `month and year of launch`, loudSpeaker: `Yes (along with the type of speakers) or No`, material: `Material used on front and back, chasis material etc.`, networkSupport: `for ex, 5g, 4g, Volte, 3g, 2g etc.`, nfc: `Indicate NFC presense`, operatingSystem: `The OS, its version, and years till software/OS and security updates/patches are provided `, otg: `Yes or No`, otherSensors: `Sensors such as Proximity sensor, Accelerometer, Compass, Gyroscope, heart rate`, peakBrightness: `Peak Brightness in Nits`, performance: `Chip name with a realistic spec score, for ex. Exynos 2100, Spec Score: x%`, pixelDensity: `Pixel Density on screen`, priceList: `Price on different platforms in indian market`, quickCharging: `type of quick charging and the wattage, Wireless charging(if available), Reverse charging(if available) & mention the time required for reference, example: 33W Fast Charging, 100% in 52 mins`, ram: `ram variants available, its type, and realistic spec score for ex. 6GB/8GB/12GB, LPDDR5, Spec Score: x%`, rearAutoFocus: `Yes or No`, rearCamera: `calculate the approx Spec Score based on quality, pixels, modes supported etc. for ex. Spec Score: x%`, rearCameraFeatures: `for Example Auto flash, face detection, Touch to Focus, OIS (if present), HDR Type`, rearCameraSetup: `Eg: Quad camera 108 MP + 12 MP(ultra-wide) + 10 MP(telephoto) + 10 MP(periscope), Spec Score: <calculate a realistic spec score %>`, rearFlash: `Yes Or No, and its Type`, rearImageResolution: `Resolutions supported`, rearOis: `Yes or No`; NEVER omit keys, NEVER repeat keys, estimate values if unsure, Expecting a 57 attribute enriched data in the output. return ONLY the final Firestore-compatible JSON object."
                }
              ]
            }')
          echo "$RESPONSE_1"
          echo "$RESPONSE_1" \
            | jq -r '.choices[0].message.content | fromjson' > base.json

          echo "===== BASE JSON ====="
          cat base.json

      # -----------------------------
      # STEP 2: ENRICHMENT CALL
      # -----------------------------
      - name: Groq Call 2 – Enrichment data
        run: |
          RESPONSE_2=$(curl -s -X POST "https://api.groq.com/openai/v1/chat/completions" \
            -H "Authorization: Bearer ${{ secrets.GROQ_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "groq/compound-mini",
              "messages": [
                {
                  "role": "user",
                  "content": "STRICT_MODE=TRUE; generate Firestore REST JSON ONLY for Motorola Edge 50 Pro enrichment data, exactly ONE JSON object in ONE single paragraph with NO line breaks, with ROOT key `fields`; EVERY field MUST use google.firestore.v1.Value wrappers (use only stringValue); include ONLY the following keys in this EXACT ORDER: rearResolution: `megapixels, cameratype, focal length, zoom, pixel size and sensor size`, rearSettings: `Any Special settings if available`, rearShootingModes: `Any Special shooting modes such as: Continuous Shooting, High Dynamic Range mode (HDR), slow-mo if available, burst mode if available`, rearVideoFeatures: `Resolution, quality, Steady video(if present), Dual recording (if available) HDR(if available), Slow-mo(if available)`, rearVideoRecording: `resolutions at corresponding FPS ex. 3840x2160 @ 60 fps, 1920x1080 @ 240 fps`, refreshRate: `The hertz rates supported, ex, 45 HZ, 60 HZ, and 120 HZ display`, resolution: `Screen Resolution appended by <pixels>`, ruggedness: `The IP rating, or any other rating mention the resistance on dust/water and the timing and depth`, sar: `For example: Head: 1.04 W/kg, Body: 1.05 W/kg`, screenProtection: `The type of protection on screen, ex: Corning Gorilla Glass Victus`, voLte: `Yes Or no`, waterproofing: `Yes or no, IP rating, Covered Under warrenty or no?`, weight: `In grams `, wifi: `Wifi version, and the bands allowed, for example: Yes, Wi-Fi 802.11, a/ac/ax/b/g/n/n 5GHz`, wifiFeatures: `Any special wifi features, such as,Mobile Hotspot`, expertRating: `out of 10 such as 9.0/10, further appended by a 150 word expert review based on the public reviews on internet`, sim1: `Provide all the types/ band number of 5g, 4g, 3g, 2g bands available for that sim slot. Example: 5G Bands: FDD N1/N3/N5, TDD N38/N40/N41, 4G Bands: TD-LTE 2600(band 38)/2300(band 40), FD-LTE 2100(band 1)/1800(band 3)/2600(band 7)/900(band 8)/700(band 28)/1900(band 2)/850(band 5)/850(band 18)/850(band 19)/800(band 20)/850(band 26), 3G Bands: UMTS 1900/2100/850/900 MHz, 2G Bands: GSM 1800/1900/850/900MHz, GPRS: Available, EDGE: Available `, sim2: `similar attributes as sim 1, as accurate data as possible`, screenSize: `Screen size in inches, ex. 6.84 inches`, screenToBodyRatio: `In percentage upto 1 decimal place, eg. 89.8%`, simSize: `Size of each of the sim, such as nano, micro, full etc.`, simSlot: `For example Dual SIM, GSM+GSM`, stereoSpeakers: `Yes or No`, storage: `The Spec Score of the storage based on the read/write speeds, the cycles supported, quality etc. For example, Spec Score: x%`, touchScreen: `For example Capacitive Touchscreen, Multi-touch`, usbConnectivity: `Type of the USB with version, and its  Speed alongside. For example Type C 3.1 (10 Gbps)`, usbType: `Type of the USB, ex. Type A to Type C, or  Type C to Lightening`,screenSize: `Screen size in inches, ex. 6.84 inches`, screenToBodyRatio: `In percentage upto 1 decimal place, eg. 89.8%`, simSize: `Mention it like - Sim1: <sim-size>, Sim2(if present): <sim-size>`, userRatings: `MUST be out of 5 with a realistic review count based on public reviews online. Mention like x/5 based on y Ratings`; NEVER omit keys, NEVER repeat keys, estimate values if unsure, and return ONLY the final Firestore-compatible JSON object."
                }
              ]
            }')

          echo "$RESPONSE_2" \
            | jq -r '.choices[0].message.content | fromjson' > enrich.json

          echo "===== ENRICHMENT JSON ====="
          cat enrich.json

      # -----------------------------
      # STEP 3: MERGE & PRINT FINAL
      # -----------------------------
      - name: Merge base + enrichment JSON
        run: |
          jq -s '
            {
              fields: (.[0].fields + .[1].fields)
            }
          ' base.json enrich.json > mobileData.json

          echo "===== FINAL MERGED FIRESTORE JSON ====="
          cat mobileData.json
     
      # -----------------------------
      # STEP 1: AUTHENTICATE GCP
      # -----------------------------
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          token_format: access_token

      # -----------------------------
      # STEP 2: CREATE FIRESTORE DOCUMENT
      # -----------------------------
      - name: Upload to Firestore
        run: |
          curl -s -w "\nHTTP %{http_code}\n" \
            -X PATCH \
            "https://firestore.googleapis.com/v1/projects/site-9686c/databases/(default)/documents/Catalogue/Moto423" \
            -H "Authorization: Bearer ${{ steps.auth.outputs.access_token }}" \
            -H "Content-Type: application/json" \
            --data-binary @mobileData.json
